<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情绪支持助手</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        // 简单的SVG图标组件
        const Heart = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        );

        const Camera = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
        );

        const Mic = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
        );

        const MessageCircle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
        );

        const Globe = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </svg>
        );

        // 新增文档图标
        const FileText = ({ className }) => (
          <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <line x1="10" y1="9" x2="8" y2="9"/>
          </svg>
        );

        // 新增拖拽手柄图标
        const DragHandle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
        );

        const EmotionalSupportApp = () => {
          const [currentView, setCurrentView] = useState('main');
          const [sosMode, setSosMode] = useState('photo');
          const [mixedMode, setMixedMode] = useState('photo-audio'); // 'photo-audio' 或 'memory-audio'
          const [currentIndex, setCurrentIndex] = useState(0);
          const [language, setLanguage] = useState('zh');
          const [photoDuration, setPhotoDuration] = useState(12);
          const [uploadedAudios, setUploadedAudios] = useState([]);
          const [uploadedPhotos, setUploadedPhotos] = useState([]);
          const [defaultPhotos, setDefaultPhotos] = useState([
            { 
              id: 1, 
              url: 'https://images.unsplash.com/photo-1544027993-37dbfe43562a?w=800&h=600&fit=crop&q=80', 
              description: { zh: '和好朋友的合照', en: 'Photo with good friends' },
              isDefault: true
            },
            { 
              id: 2, 
              url: 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=800&h=600&fit=crop&q=80', 
              description: { zh: '初中时光', en: 'Middle school days' },
              isDefault: true
            },
            { 
              id: 3, 
              url: 'https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=800&h=600&fit=crop&q=80', 
              description: { zh: '温暖的回忆', en: 'Warm memories' },
              isDefault: true
            }
          ]);
          const [defaultMemories, setDefaultMemories] = useState([
            { 
              id: 1, 
              title: { zh: '第一次获奖', en: 'First Award' }, 
              content: { zh: '记得那天你特别开心，眼睛都在发光', en: 'Remember how happy you were that day, your eyes were shining' },
              isDefault: true
            },
            { 
              id: 2, 
              title: { zh: '和朋友的午餐', en: 'Lunch with Friends' }, 
              content: { zh: '那次聊天聊到忘记时间，你笑得特别灿烂', en: 'That time you chatted until you forgot the time, you smiled so brightly' },
              isDefault: true
            },
            { 
              id: 3, 
              title: { zh: '克服困难', en: 'Overcoming Challenges' }, 
              content: { zh: '你曾经觉得不可能的事情，最后都做到了', en: 'Things you once thought impossible, you eventually accomplished them all' },
              isDefault: true
            }
          ]);
          const [notepadContent, setNotepadContent] = useState('');
          const [isAudioPlaying, setIsAudioPlaying] = useState(false);
          // 新增拖拽状态
          const [draggedItem, setDraggedItem] = useState(null);
          const [dragOverIndex, setDragOverIndex] = useState(null);
          const intervalRef = useRef(null);
          const audioRef = useRef(null);

          // 多语言文本
          const texts = {
            zh: {
              title: '情绪支持助手',
              subtitle: '你不是一个人，我们在这里陪伴你',
              sosButton: '🆘 紧急安抚',
              photoMode: '📸 安全照片',
              audioMode: '🎵 温暖声音',
              messageMode: '💭 正面记忆',
              mixedMode: '🔄 混合模式',
              photoAudioMode: '📸🎵 照片+音乐',
              memoryAudioMode: '💭🎵 文字+音乐',
              safePhotos: '安全照片',
              supportSounds: '支持声音',
              positiveMemories: '正面记忆',
              photosCount: '张照片',
              audiosCount: '段录音',
              memoriesCount: '个回忆',
              stop: '停止',
              back: '← 返回',
              yourMemories: '你的美好回忆',
              returnHome: '返回主页',
              photoDuration: '照片停留时间',
              seconds: '秒',
              minute: '分钟',
              minutes: '分钟',
              permanent: '永久',
              photoSettings: '照片设置',
              replay: '重播',
              pause: '暂停',
              resume: '继续'
            },
            en: {
              title: 'Emotional Support Assistant',
              subtitle: 'You are not alone, we are here with you',
              sosButton: '🆘 Emergency Comfort',
              photoMode: '📸 Safe Photos',
              audioMode: '🎵 Warm Sounds',
              messageMode: '💭 Positive Memories',
              mixedMode: '🔄 Mixed Mode',
              photoAudioMode: '📸🎵 Photo+Music',
              memoryAudioMode: '💭🎵 Text+Music',
              safePhotos: 'Safe Photos',
              supportSounds: 'Support Sounds',
              positiveMemories: 'Positive Memories',
              photosCount: 'photos',
              audiosCount: 'audios',
              memoriesCount: 'memories',
              stop: 'Stop',
              back: '← Back',
              yourMemories: 'Your Beautiful Memories',
              returnHome: 'Return Home',
              photoDuration: 'Photo Duration',
              seconds: 'seconds',
              minute: 'minute',
              minutes: 'minutes',
              permanent: 'Permanent',
              photoSettings: 'Photo Settings',
              replay: 'Replay',
              pause: 'Pause',
              resume: 'Resume'
            }
          };

          const t = texts[language];

          // 固定的示例数据 - 现在使用state管理
          // 合并默认照片和用户上传的照片
          const allPhotos = [...defaultPhotos, ...uploadedPhotos];

          const defaultMemoryData = defaultMemories;

          // 合并默认回忆和Notepad内容
          const allMemories = notepadContent.trim() ? 
            [...defaultMemoryData, {
              id: 'notepad',
              title: { zh: '我的心灵笔记', en: 'My Heart Notes' },
              content: { zh: notepadContent, en: notepadContent },
              isNotepad: true
            }] : defaultMemoryData;

          // 新增拖拽排序功能 - 通用版本
          const handleDragStart = (e, index, type) => {
            setDraggedItem({ index, type });
            e.dataTransfer.effectAllowed = 'move';
          };

          const handleDragOver = (e, index) => {
            e.preventDefault();
            setDragOverIndex(index);
          };

          const handleDragLeave = () => {
            setDragOverIndex(null);
          };

          const handleDrop = (e, dropIndex, type) => {
            e.preventDefault();
            if (draggedItem !== null && draggedItem.index !== dropIndex && draggedItem.type === type) {
              if (type === 'audio') {
                const newAudios = [...uploadedAudios];
                const draggedAudio = newAudios[draggedItem.index];
                newAudios.splice(draggedItem.index, 1);
                newAudios.splice(dropIndex, 0, draggedAudio);
                setUploadedAudios(newAudios);
              } else if (type === 'photo') {
                const newPhotos = [...allPhotos];
                const draggedPhoto = newPhotos[draggedItem.index];
                newPhotos.splice(draggedItem.index, 1);
                newPhotos.splice(dropIndex, 0, draggedPhoto);
                // 分离默认和用户照片
                const defaultPhotos = newPhotos.filter(p => p.isDefault);
                const userPhotos = newPhotos.filter(p => !p.isDefault);
                setUploadedPhotos(userPhotos);
              } else if (type === 'memory') {
                const newMemories = [...allMemories];
                const draggedMemory = newMemories[draggedItem.index];
                newMemories.splice(draggedItem.index, 1);
                newMemories.splice(dropIndex, 0, draggedMemory);
                // 分离默认和用户回忆
                const userMemories = newMemories.filter(m => !m.isDefault);
                setUploadedMemories(userMemories);
              }
            }
            setDraggedItem(null);
            setDragOverIndex(null);
          };

          const handleDragEnd = () => {
            setDraggedItem(null);
            setDragOverIndex(null);
          };

          // 音频播放控制函数
          const playAudio = (audioUrl) => {
            if (audioRef.current) {
              audioRef.current.src = audioUrl;
              audioRef.current.play().then(() => {
                setIsAudioPlaying(true);
              }).catch(err => {
                alert(language === 'zh' ? '播放失败，请检查音频格式' : 'Playback failed, check audio format');
              });
            }
          };

          const pauseAudio = () => {
            if (audioRef.current) {
              audioRef.current.pause();
              setIsAudioPlaying(false);
            }
          };

          const resumeAudio = () => {
            if (audioRef.current) {
              audioRef.current.play().then(() => {
                setIsAudioPlaying(true);
              });
            }
          };

          const stopAudio = () => {
            if (audioRef.current) {
              audioRef.current.pause();
              audioRef.current.currentTime = 0;
              setIsAudioPlaying(false);
            }
          };

          // SOS按钮功能
          const handleSOS = () => {
            setCurrentIndex(0);
            
            if (sosMode === 'photo') {
              startPhotoSlideshow();
            } else if (sosMode === 'audio') {
              if (uploadedAudios.length > 0) {
                setCurrentView('audio');
                // 最小延迟启动播放
                setTimeout(() => {
                  const firstAudio = uploadedAudios[0];
                  if (firstAudio && audioRef.current) {
                    audioRef.current.src = firstAudio.audioUrl;
                    audioRef.current.play().then(() => {
                      setIsAudioPlaying(true);
                    }).catch(err => {
                      console.log('初始播放失败，重试:', err);
                      setTimeout(() => {
                        audioRef.current.play();
                      }, 50);
                    });
                  }
                }, 50); // 减少到最小延迟
              } else {
                setCurrentView('audio');
              }
            } else if (sosMode === 'message') {
              if (allMemories.length > 0) {
                setCurrentView('memories-slideshow');
              } else {
                setCurrentView('memories');
              }
            } else if (sosMode === 'mixed') {
              // 根据选择的混合模式启动
              if (mixedMode === 'photo-audio') {
                if (allPhotos.length > 0 && uploadedAudios.length > 0) {
                  setCurrentView('mixed-photo-audio');
                  // 启动照片幻灯片和音乐播放
                  if (photoDuration > 0) {
                    intervalRef.current = setInterval(() => {
                      setCurrentIndex(prev => (prev + 1) % allPhotos.length);
                    }, photoDuration * 1000);
                  }
                  // 启动音乐播放
                  setTimeout(() => {
                    const firstAudio = uploadedAudios[0];
                    if (firstAudio && audioRef.current) {
                      audioRef.current.src = firstAudio.audioUrl;
                      audioRef.current.play().then(() => {
                        setIsAudioPlaying(true);
                      }).catch(err => {
                        console.log('音乐播放失败，重试:', err);
                        setTimeout(() => {
                          audioRef.current.play();
                        }, 50);
                      });
                    }
                  }, 50);
                } else {
                  alert(language === 'zh' ? '需要同时有照片和音频文件才能使用此模式' : 'Need both photos and audio files to use this mode');
                }
              } else if (mixedMode === 'memory-audio') {
                if (allMemories.length > 0 && uploadedAudios.length > 0) {
                  setCurrentView('mixed-memory-audio');
                  // 启动音乐播放
                  setTimeout(() => {
                    const firstAudio = uploadedAudios[0];
                    if (firstAudio && audioRef.current) {
                      audioRef.current.src = firstAudio.audioUrl;
                      audioRef.current.play().then(() => {
                        setIsAudioPlaying(true);
                      }).catch(err => {
                        console.log('音乐播放失败，重试:', err);
                        setTimeout(() => {
                          audioRef.current.play();
                        }, 50);
                      });
                    }
                  }, 50);
                } else {
                  alert(language === 'zh' ? '需要同时有回忆和音频文件才能使用此模式' : 'Need both memories and audio files to use this mode');
                }
              }
            }
          };

          // 播放下一首音频 - 优化为最快切换
          const playNextAudio = () => {
            if (uploadedAudios.length > 1) {
              const nextIndex = (currentIndex + 1) % uploadedAudios.length;
              setCurrentIndex(nextIndex);
              const nextAudio = uploadedAudios[nextIndex];
              if (nextAudio && audioRef.current) {
                // 立即切换，无延迟
                audioRef.current.src = nextAudio.audioUrl;
                audioRef.current.play().catch(err => {
                  console.log('播放失败，尝试重新播放:', err);
                  // 如果失败，立即重试
                  setTimeout(() => {
                    audioRef.current.play();
                  }, 50);
                });
              }
            } else if (uploadedAudios.length === 1) {
              // 如果只有一首歌，立即重新播放
              if (audioRef.current) {
                audioRef.current.currentTime = 0;
                audioRef.current.play();
              }
            }
          };

          const startPhotoSlideshow = () => {
            setCurrentView('slideshow');
            if (photoDuration > 0) {
              intervalRef.current = setInterval(() => {
                setCurrentIndex(prev => (prev + 1) % allPhotos.length);
              }, photoDuration * 1000);
            }
          };

          const stopSOS = () => {
            if (intervalRef.current) {
              clearInterval(intervalRef.current);
            }
            // 确保完全停止音频并重置状态
            if (audioRef.current) {
              audioRef.current.pause();
              audioRef.current.currentTime = 0;
              setIsAudioPlaying(false);
            }
            setCurrentView('main');
          };

          // 主界面
          if (currentView === 'main') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                <div className="max-w-md mx-auto">
                  {/* 语言切换按钮 */}
                  <div className="flex justify-end pt-4 mb-4">
                    <button
                      onClick={() => setLanguage(language === 'zh' ? 'en' : 'zh')}
                      className="flex items-center space-x-2 bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 px-3 py-2 rounded-lg shadow-sm hover:from-pink-100 hover:to-rose-100"
                    >
                      <Globe className="w-4 h-4 text-gray-600" />
                      <span className="text-sm text-gray-600">
                        {language === 'zh' ? 'EN' : '中文'}
                      </span>
                    </button>
                  </div>

                  {/* 标题 */}
                  <div className="text-center mb-8">
                    <Heart className="w-12 h-12 text-pink-500 mx-auto mb-2" />
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">{t.title}</h1>
                    <p className="text-gray-600">{t.subtitle}</p>
                  </div>

                  {/* SOS 按钮 */}
                  <div className="mb-8">
                    <button
                      onClick={handleSOS}
                      className="w-full bg-red-500 hover:bg-red-600 text-white text-xl font-bold py-6 px-8 rounded-full shadow-lg transform transition-all duration-200 hover:scale-105 active:scale-95"
                    >
                      {t.sosButton}
                    </button>
                    
                    {/* SOS 模式选择 */}
                    <div className="mt-4 grid grid-cols-2 gap-2">
                      <button
                        onClick={() => setSosMode('photo')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'photo' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.photoMode}
                      </button>
                      <button
                        onClick={() => setSosMode('audio')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'audio' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.audioMode}
                      </button>
                      <button
                        onClick={() => setSosMode('message')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'message' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.messageMode}
                      </button>
                      <button
                        onClick={() => setSosMode('mixed')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'mixed' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.mixedMode}
                      </button>
                    </div>

                    {/* 混合模式的子选项 */}
                    {sosMode === 'mixed' && (
                      <div className="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg">
                        <p className="text-sm text-gray-700 mb-3 text-center font-medium">
                          {language === 'zh' ? '选择混合模式类型:' : 'Choose Mixed Mode Type:'}
                        </p>
                        <div className="grid grid-cols-1 gap-2">
                          <button
                            onClick={() => setMixedMode('photo-audio')}
                            className={`py-3 px-4 rounded-lg text-sm transition-colors ${mixedMode === 'photo-audio' ? 'bg-purple-500 text-white' : 'bg-white border border-purple-200 text-gray-700 hover:bg-purple-50'}`}
                          >
                            {t.photoAudioMode}
                            <p className="text-xs mt-1 opacity-80">
                              {language === 'zh' ? '同时播放照片幻灯片和背景音乐' : 'Play photo slideshow with background music'}
                            </p>
                          </button>
                          <button
                            onClick={() => setMixedMode('memory-audio')}
                            className={`py-3 px-4 rounded-lg text-sm transition-colors ${mixedMode === 'memory-audio' ? 'bg-purple-500 text-white' : 'bg-white border border-purple-200 text-gray-700 hover:bg-purple-50'}`}
                          >
                            {t.memoryAudioMode}
                            <p className="text-xs mt-1 opacity-80">
                              {language === 'zh' ? '显示文字回忆并播放背景音乐' : 'Show text memories with background music'}
                            </p>
                          </button>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* 设置区域 */}
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md mb-6">
                    <h3 className="font-semibold text-gray-800 mb-4 text-center">{t.photoSettings}</h3>
                    
                    <div>
                      <p className="text-sm text-gray-600 mb-2">{t.photoDuration}:</p>
                      <div className="grid grid-cols-3 gap-2">
                        {[
                          { value: 10, label: `10 ${t.seconds}` },
                          { value: 20, label: `20 ${t.seconds}` },
                          { value: 60, label: `1 ${t.minute}` },
                          { value: 300, label: `5 ${t.minutes}` },
                          { value: 1800, label: `30 ${t.minutes}` },
                          { value: 0, label: t.permanent }
                        ].map(option => (
                          <button
                            key={option.value}
                            onClick={() => setPhotoDuration(option.value)}
                            className={`py-2 px-2 rounded-lg text-xs transition-colors ${
                              photoDuration === option.value 
                                ? 'bg-blue-500 text-white' 
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                          >
                            {option.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* 功能卡片 */}
                  <div className="grid grid-cols-1 gap-4">
                    <div 
                      onClick={() => setCurrentView('photos')}
                      className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:from-pink-100 hover:to-rose-100 transition-all"
                    >
                      <div className="flex items-center">
                        <Camera className="w-8 h-8 text-pink-500 mr-3" />
                        <div>
                          <h3 className="font-semibold text-gray-800">{t.safePhotos}</h3>
                          <p className="text-sm text-gray-600">{allPhotos.length} {t.photosCount}</p>
                        </div>
                      </div>
                    </div>

                    <div 
                      onClick={() => setCurrentView('audios')}
                      className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:from-pink-100 hover:to-rose-100 transition-all"
                    >
                      <div className="flex items-center">
                        <Mic className="w-8 h-8 text-pink-500 mr-3" />
                        <div>
                          <h3 className="font-semibold text-gray-800">{t.supportSounds}</h3>
                          <p className="text-sm text-gray-600">{uploadedAudios.length} {t.audiosCount}</p>
                        </div>
                      </div>
                    </div>

                    <div 
                      onClick={() => setCurrentView('memories')}
                      className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:from-pink-100 hover:to-rose-100 transition-all"
                    >
                      <div className="flex items-center">
                        <MessageCircle className="w-8 h-8 text-pink-500 mr-3" />
                        <div>
                          <h3 className="font-semibold text-gray-800">{t.positiveMemories}</h3>
                          <p className="text-sm text-gray-600">{allMemories.length} {t.memoriesCount}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // 照片幻灯片视图
          if (currentView === 'slideshow') {
            return (
              <div className="min-h-screen bg-black relative flex items-center justify-center">
                <img
                  src={allPhotos[currentIndex]?.url}
                  alt={allPhotos[currentIndex]?.description[language]}
                  className="max-w-full max-h-full object-contain"
                  style={{
                    maxWidth: '90%',
                    maxHeight: '80%',
                    borderRadius: '12px',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.5)'
                  }}
                />
                <div className="absolute bottom-20 left-0 right-0 text-center">
                  <div className="bg-black bg-opacity-70 mx-4 p-4 rounded-lg">
                    <p className="text-white text-xl mb-4">{allPhotos[currentIndex]?.description[language]}</p>
                    <button
                      onClick={stopSOS}
                      className="bg-white text-black px-6 py-3 rounded-full font-semibold hover:bg-gray-100 transition-colors"
                    >
                      {t.stop}
                    </button>
                  </div>
                </div>
                
                <div className="absolute top-4 right-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg">
                  {currentIndex + 1} / {allPhotos.length}
                </div>

                <div className="absolute top-4 left-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg text-sm">
                  {photoDuration === 0 && t.permanent}
                  {photoDuration === 10 && `10 ${t.seconds}`}
                  {photoDuration === 20 && `20 ${t.seconds}`}
                  {photoDuration === 60 && `1 ${t.minute}`}
                  {photoDuration === 300 && `5 ${t.minutes}`}
                  {photoDuration === 1800 && `30 ${t.minutes}`}
                </div>
                
                <button
                  onClick={() => setCurrentIndex((prev) => (prev - 1 + allPhotos.length) % allPhotos.length)}
                  className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all"
                >
                  ←
                </button>
                <button
                  onClick={() => setCurrentIndex((prev) => (prev + 1) % allPhotos.length)}
                  className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all"
                >
                  →
                </button>
              </div>
            );
          }

          // 混合模式：照片+音乐
          if (currentView === 'mixed-photo-audio') {
            return (
              <div className="min-h-screen bg-black relative flex items-center justify-center">
                <img
                  src={allPhotos[currentIndex]?.url}
                  alt={allPhotos[currentIndex]?.description[language]}
                  className="max-w-full max-h-full object-contain"
                  style={{
                    maxWidth: '90%',
                    maxHeight: '80%',
                    borderRadius: '12px',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.5)'
                  }}
                />
                
                {/* 音乐控制和照片信息 */}
                <div className="absolute bottom-20 left-0 right-0 text-center">
                  <div className="bg-black bg-opacity-70 mx-4 p-4 rounded-lg">
                    <p className="text-white text-xl mb-2">{allPhotos[currentIndex]?.description[language]}</p>
                    
                    {/* 当前播放的音乐信息 */}
                    {uploadedAudios[currentIndex % uploadedAudios.length] && (
                      <div className="text-white text-sm mb-4 opacity-80">
                        🎵 {uploadedAudios[currentIndex % uploadedAudios.length].fileName}
                        {isAudioPlaying && (
                          <span className="ml-2 text-green-400">播放中...</span>
                        )}
                      </div>
                    )}
                    
                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={stopSOS}
                        className="bg-white text-black px-6 py-3 rounded-full font-semibold hover:bg-gray-100 transition-colors"
                      >
                        {t.stop}
                      </button>
                      {isAudioPlaying && (
                        <button
                          onClick={pauseAudio}
                          className="bg-yellow-500 text-white px-4 py-3 rounded-full font-semibold hover:bg-yellow-600 transition-colors"
                        >
                          {t.pause}
                        </button>
                      )}
                      {!isAudioPlaying && uploadedAudios.length > 0 && (
                        <button
                          onClick={resumeAudio}
                          className="bg-green-500 text-white px-4 py-3 rounded-full font-semibold hover:bg-green-600 transition-colors"
                        >
                          {t.resume}
                        </button>
                      )}
                    </div>
                  </div>
                </div>
                
                {/* 进度指示器 */}
                <div className="absolute top-4 right-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg">
                  📸 {currentIndex + 1} / {allPhotos.length}
                </div>

                <div className="absolute top-4 left-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg text-sm">
                  {photoDuration === 0 && t.permanent}
                  {photoDuration === 10 && `10 ${t.seconds}`}
                  {photoDuration === 20 && `20 ${t.seconds}`}
                  {photoDuration === 60 && `1 ${t.minute}`}
                  {photoDuration === 300 && `5 ${t.minutes}`}
                  {photoDuration === 1800 && `30 ${t.minutes}`}
                </div>
                
                {/* 照片导航按钮 */}
                <button
                  onClick={() => setCurrentIndex((prev) => (prev - 1 + allPhotos.length) % allPhotos.length)}
                  className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all"
                >
                  ←
                </button>
                <button
                  onClick={() => setCurrentIndex((prev) => (prev + 1) % allPhotos.length)}
                  className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all"
                >
                  →
                </button>

                {/* 隐藏的音频播放器 */}
                <audio 
                  ref={audioRef} 
                  style={{ display: 'none' }} 
                  onEnded={playNextAudio}
                  onPause={() => setIsAudioPlaying(false)}
                  onPlay={() => setIsAudioPlaying(true)}
                  preload="auto"
                />
              </div>
            );
          }

          // 混合模式：文字+音乐
          if (currentView === 'mixed-memory-audio') {
            if (allMemories.length === 0) {
              return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4 flex items-center justify-center">
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-8 rounded-xl shadow-lg text-center max-w-md">
                    <MessageCircle className="w-16 h-16 text-pink-500 mx-auto mb-4" />
                    <h2 className="text-xl font-bold mb-4">
                      {language === 'zh' ? '还没有回忆记录' : 'No Memory Records'}
                    </h2>
                    <p className="text-gray-600 mb-6">
                      {language === 'zh' ? 
                        '请先上传一些美好回忆来使用此功能' : 
                        'Please upload some wonderful memories to use this feature'}
                    </p>
                    <button
                      onClick={() => setCurrentView('memories')}
                      className="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors"
                    >
                      {language === 'zh' ? '去上传回忆' : 'Upload Memories'}
                    </button>
                  </div>
                </div>
              );
            }

            const currentMemory = allMemories[currentIndex] || allMemories[0];
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4 flex items-center justify-center">
                <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-8 rounded-xl shadow-lg text-center max-w-lg">
                  <MessageCircle className="w-16 h-16 text-pink-500 mx-auto mb-4" />
                  <h2 className="text-xl font-bold mb-4">{currentMemory.title[language]}</h2>
                  
                  {/* 美化的文本显示区域 */}
                  <div className="bg-gradient-to-r from-pink-100 to-rose-100 border border-pink-200 p-6 rounded-lg mb-4 max-h-64 overflow-y-auto">
                    <p className="text-gray-700 leading-relaxed whitespace-pre-wrap text-left">
                      {currentMemory.content[language]}
                    </p>
                  </div>
                  
                  {/* 当前播放的音乐信息 */}
                  {uploadedAudios[currentIndex % uploadedAudios.length] && (
                    <div className="bg-gradient-to-r from-green-100 to-blue-100 border border-green-200 p-3 rounded-lg mb-4">
                      <div className="text-sm text-gray-700">
                        🎵 {uploadedAudios[currentIndex % uploadedAudios.length].fileName}
                        {isAudioPlaying && (
                          <span className="ml-2 text-green-600 font-medium">
                            {language === 'zh' ? '播放中...' : 'Playing...'}
                          </span>
                        )}
                      </div>
                    </div>
                  )}
                  
                  {/* 显示当前进度 */}
                  <p className="text-sm text-purple-600 mb-4">
                    {language === 'zh' ? 
                      `回忆: ${currentIndex + 1} / ${allMemories.length}` : 
                      `Memory: ${currentIndex + 1} / ${allMemories.length}`}
                  </p>
                  
                  <div className="flex justify-center space-x-3 mb-4">
                    <button
                      onClick={stopSOS}
                      className="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors"
                    >
                      {language === 'zh' ? '停止' : 'Stop'}
                    </button>
                    {isAudioPlaying && (
                      <button
                        onClick={pauseAudio}
                        className="bg-yellow-500 text-white px-4 py-3 rounded-lg hover:bg-yellow-600 transition-colors"
                      >
                        {t.pause}
                      </button>
                    )}
                    {!isAudioPlaying && uploadedAudios.length > 0 && (
                      <button
                        onClick={resumeAudio}
                        className="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors"
                      >
                        {t.resume}
                      </button>
                    )}
                  </div>

                  {/* 手动切换按钮 */}
                  {allMemories.length > 1 && (
                    <div className="flex justify-center space-x-2">
                      <button
                        onClick={() => {
                          const prevIndex = (currentIndex - 1 + allMemories.length) % allMemories.length;
                          setCurrentIndex(prevIndex);
                        }}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        {language === 'zh' ? '← 上一个' : '← Previous'}
                      </button>
                      <button
                        onClick={() => {
                          const nextIndex = (currentIndex + 1) % allMemories.length;
                          setCurrentIndex(nextIndex);
                        }}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        {language === 'zh' ? '下一个 →' : 'Next →'}
                      </button>
                    </div>
                  )}

                  {/* 隐藏的音频播放器 */}
                  <audio 
                    ref={audioRef} 
                    style={{ display: 'none' }} 
                    onEnded={playNextAudio}
                    onPause={() => setIsAudioPlaying(false)}
                    onPlay={() => setIsAudioPlaying(true)}
                    preload="auto"
                  />
                </div>
              </div>
            );
          }

          // 记忆幻灯片视图 - 新增SOS播放模式
          if (currentView === 'memories-slideshow') {
            if (allMemories.length === 0) {
              return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4 flex items-center justify-center">
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-8 rounded-xl shadow-lg text-center max-w-md">
                    <MessageCircle className="w-16 h-16 text-pink-500 mx-auto mb-4" />
                    <h2 className="text-xl font-bold mb-4">
                      {language === 'zh' ? '还没有回忆记录' : 'No Memory Records'}
                    </h2>
                    <p className="text-gray-600 mb-6">
                      {language === 'zh' ? 
                        '请先上传一些美好回忆来使用此功能' : 
                        'Please upload some wonderful memories to use this feature'}
                    </p>
                    <button
                      onClick={() => setCurrentView('memories')}
                      className="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors"
                    >
                      {language === 'zh' ? '去上传回忆' : 'Upload Memories'}
                    </button>
                  </div>
                </div>
              );
            }

            const currentMemory = allMemories[currentIndex] || allMemories[0];
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4 flex items-center justify-center">
                <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-8 rounded-xl shadow-lg text-center max-w-lg">
                  <MessageCircle className="w-16 h-16 text-pink-500 mx-auto mb-4" />
                  <h2 className="text-xl font-bold mb-4">{currentMemory.title[language]}</h2>
                  
                  {/* 美化的文本显示区域 */}
                  <div className="bg-gradient-to-r from-pink-100 to-rose-100 border border-pink-200 p-6 rounded-lg mb-6 max-h-64 overflow-y-auto">
                    <p className="text-gray-700 leading-relaxed whitespace-pre-wrap text-left">
                      {currentMemory.content[language]}
                    </p>
                  </div>
                  
                  {/* 显示当前进度 */}
                  <p className="text-sm text-purple-600 mb-4">
                    {language === 'zh' ? 
                      `回忆: ${currentIndex + 1} / ${allMemories.length}` : 
                      `Memory: ${currentIndex + 1} / ${allMemories.length}`}
                  </p>
                  
                  <div className="flex justify-center space-x-4 mb-4">
                    <button
                      onClick={stopSOS}
                      className="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors"
                    >
                      {language === 'zh' ? '停止' : 'Stop'}
                    </button>
                    <button
                      onClick={() => {
                        setCurrentView('main');
                      }}
                      className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors"
                    >
                      {language === 'zh' ? '返回' : 'Back'}
                    </button>
                  </div>

                  {/* 手动切换按钮 */}
                  {allMemories.length > 1 && (
                    <div className="flex justify-center space-x-2">
                      <button
                        onClick={() => {
                          const prevIndex = (currentIndex - 1 + allMemories.length) % allMemories.length;
                          setCurrentIndex(prevIndex);
                        }}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        {language === 'zh' ? '← 上一个' : '← Previous'}
                      </button>
                      <button
                        onClick={() => {
                          const nextIndex = (currentIndex + 1) % allMemories.length;
                          setCurrentIndex(nextIndex);
                        }}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        {language === 'zh' ? '下一个 →' : 'Next →'}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          // 记忆视图 - 增加上传功能
          if (currentView === 'memories') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4">
                <div className="max-w-md mx-auto pt-8">
                  <div className="flex items-center justify-between mb-6">
                    <button
                      onClick={() => setCurrentView('main')}
                      className="text-purple-500 font-semibold"
                    >
                      {t.back}
                    </button>
                    <h2 className="text-xl font-bold text-center">{t.yourMemories}</h2>
                    <div></div>
                  </div>

                  {/* 心灵笔记区域 - 替代文档上传 */}
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-6 rounded-xl shadow-md mb-6">
                    <h3 className="font-semibold mb-4 text-center">
                      {language === 'zh' ? '✨ 心灵笔记 ✨' : '✨ Heart Notes ✨'}
                    </h3>
                    
                    {/* 温暖的使用说明 */}
                    <div className="bg-gradient-to-r from-pink-100 to-rose-100 border border-pink-200 p-4 rounded-lg mb-4">
                      <p className="text-sm text-gray-700 leading-relaxed text-center">
                        {language === 'zh' ? 
                          '💝 在这里写下那些温暖的话语，记录美好的时刻，或是给自己的鼓励。在需要的时候，这些文字会成为你内心的光芒。' : 
                          '💝 Write warm words here, record beautiful moments, or give yourself encouragement. When needed, these words will become the light in your heart.'}
                      </p>
                    </div>
                    
                    <textarea
                      value={notepadContent}
                      onChange={(e) => setNotepadContent(e.target.value)}
                      placeholder={language === 'zh' ? 
                        '在这里写下你的美好回忆、成就、感谢的话语，或任何能让你感到温暖的文字...\n\n例如：\n• 今天我完成了一个重要的项目\n• 朋友给了我很大的支持\n• 我比昨天的自己更强大了' : 
                        'Write your beautiful memories, achievements, words of gratitude, or any text that makes you feel warm...\n\nFor example:\n• Today I completed an important project\n• Friends gave me great support\n• I am stronger than yesterday'}
                      className="w-full h-48 p-4 border border-pink-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-transparent bg-white shadow-inner"
                      style={{
                        fontFamily: 'system-ui, -apple-system, sans-serif',
                        fontSize: '14px',
                        lineHeight: '1.6'
                      }}
                    />
                    
                    <div className="mt-3 text-center">
                      <p className="text-xs text-gray-500">
                        {language === 'zh' ? 
                          `已写入 ${notepadContent.length} 个字符` : 
                          `${notepadContent.length} characters written`}
                      </p>
                    </div>
                  </div>

                  {/* 回忆列表 - 简化显示 */}
                  <div className="space-y-4">
                    <h4 className="font-semibold text-gray-800">
                      {language === 'zh' ? '所有美好回忆' : 'All Beautiful Memories'}
                    </h4>
                    {allMemories.map((memory, index) => (
                      <div 
                        key={memory.id} 
                        className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md relative"
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center mb-2">
                              <span className="bg-pink-500 text-white text-sm px-3 py-1 rounded-full mr-3 flex-shrink-0">
                                {index + 1}
                              </span>
                              <h3 className="font-semibold text-lg">{memory.title[language]}</h3>
                            </div>
                            <p className="text-gray-700 text-sm leading-relaxed">{memory.content[language]}</p>
                          </div>
                          <div className="ml-2 flex-shrink-0">
                            {memory.isNotepad && (
                              <button
                                onClick={() => setNotepadContent('')}
                                className="bg-yellow-500 text-white px-3 py-1 rounded text-xs hover:bg-yellow-600 transition-colors"
                              >
                                {language === 'zh' ? '清空' : 'Clear'}
                              </button>
                            )}
                            {memory.isDefault && (
                              <button
                                onClick={() => setDefaultMemories(prev => prev.filter(m => m.id !== memory.id))}
                                className="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                              >
                                {language === 'zh' ? '删除' : 'Delete'}
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* 空状态 */}
                  {allMemories.length === 0 && (
                    <div className="text-center text-gray-500 mt-8">
                      <FileText className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                      <p className="mb-2 font-medium">
                        {language === 'zh' ? '还没有任何回忆记录' : 'No memory records yet'}
                      </p>
                      <p className="text-sm px-4">
                        {language === 'zh' ? 
                          '开始记录那些让你感到骄傲和快乐的时刻吧' : 
                          'Start recording moments that make you feel proud and happy'}
                      </p>
                    </div>
                  )}

                  <button
                    onClick={stopSOS}
                    className="w-full mt-6 bg-purple-500 text-white py-3 rounded-lg font-semibold"
                  >
                    {t.returnHome}
                  </button>
                </div>
              </div>
            );
          }

          // 音频管理视图 - 包含新的拖拽排序功能
          if (currentView === 'audios') {
            return (
              <div className="min-h-screen bg-gray-50 p-4">
                <div className="max-w-md mx-auto">
                  <div className="flex items-center justify-between mb-6 pt-8">
                    <button
                      onClick={() => setCurrentView('main')}
                      className="text-blue-500 font-semibold"
                    >
                      {t.back}
                    </button>
                    <h2 className="text-xl font-bold">{t.supportSounds}</h2>
                    <div></div>
                  </div>

                  {/* 文件上传区域 */}
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-6 rounded-xl shadow-md mb-6">
                    <h3 className="font-semibold mb-4 text-center">
                      {language === 'zh' ? '上传音频文件' : 'Upload Audio Files'}
                    </h3>
                    
                    {/* 温暖的使用说明 */}
                    <div className="bg-gradient-to-r from-pink-100 to-rose-100 border border-pink-200 p-4 rounded-lg mb-4">
                      <p className="text-sm text-gray-700 leading-relaxed text-center">
                        {language === 'zh' ? 
                          '💝 使用手机录音记录家人朋友的温暖话语，或上传让你感到安心的音乐。在紧张焦虑时，这些熟悉的声音会像拥抱一样陪伴你，提醒你并不孤单。' : 
                          '💝 Record warm words from family and friends, or upload music that brings you comfort. During anxious moments, these familiar sounds will embrace you like a hug, reminding you that you are not alone.'}
                      </p>
                    </div>
                    
                    <p className="text-sm text-gray-600 mb-4 text-center">
                      {language === 'zh' ? 
                        '支持格式: MP3, MP4, WAV, FLAC, AAC, AMR, OGG, M4A' : 
                        'Supported: MP3, MP4, WAV, FLAC, AAC, AMR, OGG, M4A'}
                    </p>
                    
                    <div className="relative">
                      <input
                        type="file"
                        accept="audio/*,.mp3,.mp4,.wav,.flac,.aac,.amr,.ogg,.m4a,.wma"
                        multiple
                        onChange={(e) => {
                          const files = Array.from(e.target.files);
                          files.forEach((file, index) => {
                            const url = URL.createObjectURL(file);
                            const newAudio = {
                              id: Date.now() + index,
                              fileName: file.name,
                              audioUrl: url,
                              fileSize: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                              fileType: file.type || 'Unknown'
                            };
                            setUploadedAudios(prev => [...prev, newAudio]);
                          });
                          e.target.value = ''; // 清空输入，允许重复上传相同文件
                        }}
                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        id="audioUpload"
                      />
                      <label 
                        htmlFor="audioUpload"
                        className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-pink-300 rounded-lg cursor-pointer hover:border-pink-500 hover:bg-pink-100 transition-all"
                      >
                        <Mic className="w-8 h-8 text-gray-400 mb-2" />
                        <p className="text-sm text-gray-600 text-center px-4">
                          {language === 'zh' ? 
                            '点击选择音频文件或拖拽到这里' : 
                            'Click to select audio files or drag them here'}
                        </p>
                      </label>
                    </div>
                  </div>

                  {/* 音频列表 - 包含拖拽排序功能 */}
                  {uploadedAudios.length > 0 && (
                    <div className="space-y-4">
                      <h4 className="font-semibold text-gray-800">
                        {language === 'zh' ? '已上传的音频文件 (拖拽重新排序)' : 'Uploaded Audio Files (Drag to Reorder)'}
                      </h4>
                      {uploadedAudios.map((audio, index) => (
                        <div 
                          key={audio.id} 
                          draggable
                          onDragStart={(e) => handleDragStart(e, index, 'audio')}
                          onDragOver={(e) => handleDragOver(e, index)}
                          onDragLeave={handleDragLeave}
                          onDrop={(e) => handleDrop(e, index, 'audio')}
                          onDragEnd={handleDragEnd}
                          className={`bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-move transition-all duration-200 ${
                            draggedItem && draggedItem.index === index && draggedItem.type === 'audio' ? 'opacity-50 scale-95' : ''
                          } ${
                            dragOverIndex === index && draggedItem !== null && draggedItem.type === 'audio' && draggedItem.index !== index 
                              ? 'border-2 border-pink-400 border-dashed transform scale-105' 
                              : 'border-pink-100'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center flex-1 min-w-0">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center">
                                  <span className="bg-pink-500 text-white text-sm px-3 py-1 rounded-full mr-3 flex-shrink-0">
                                    {index + 1}
                                  </span>
                                  <p className="font-semibold text-sm truncate">{audio.fileName}</p>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">{audio.fileSize} • {audio.fileType}</p>
                              </div>
                            </div>
                            <div className="flex flex-col space-y-2 ml-2 flex-shrink-0">
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => playAudio(audio.audioUrl)}
                                  className="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
                                >
                                  {language === 'zh' ? '播放' : 'Play'}
                                </button>
                                {isAudioPlaying && (
                                  <button
                                    onClick={stopAudio}
                                    className="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 transition-colors"
                                  >
                                    {language === 'zh' ? '停止' : 'Stop'}
                                  </button>
                                )}
                              </div>
                              <div className="flex space-x-2">
                                {index > 0 && (
                                  <button
                                    onClick={() => {
                                      const newAudios = [...uploadedAudios];
                                      const temp = newAudios[index];
                                      newAudios[index] = newAudios[index - 1];
                                      newAudios[index - 1] = temp;
                                      setUploadedAudios(newAudios);
                                    }}
                                    className="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                  >
                                    ↑
                                  </button>
                                )}
                                {index < uploadedAudios.length - 1 && (
                                  <button
                                    onClick={() => {
                                      const newAudios = [...uploadedAudios];
                                      const temp = newAudios[index];
                                      newAudios[index] = newAudios[index + 1];
                                      newAudios[index + 1] = temp;
                                      setUploadedAudios(newAudios);
                                    }}
                                    className="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                  >
                                    ↓
                                  </button>
                                )}
                                <button
                                  onClick={() => {
                                    setUploadedAudios(prev => prev.filter(a => a.id !== audio.id));
                                    URL.revokeObjectURL(audio.audioUrl);
                                  }}
                                  className="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                                >
                                  删
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* 空状态 */}
                  {uploadedAudios.length === 0 && (
                    <div className="text-center text-gray-500 mt-8">
                      <Mic className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                      <p className="mb-2 font-medium">
                        {language === 'zh' ? '还没有上传任何音频文件' : 'No audio files uploaded yet'}
                      </p>
                      <p className="text-sm px-4">
                        {language === 'zh' ? 
                          '开始收集那些能给你力量的声音吧 - 也许是妈妈的叮咛，朋友的鼓励，或是你最爱的歌曲' : 
                          'Start collecting sounds that give you strength - maybe mom\'s caring words, a friend\'s encouragement, or your favorite song'}
                      </p>
                    </div>
                  )}

                  {/* 隐藏的音频播放器 */}
                  <audio 
                    ref={audioRef} 
                    style={{ display: 'none' }} 
                    onEnded={() => setIsAudioPlaying(false)}
                    onPause={() => setIsAudioPlaying(false)}
                    onPlay={() => setIsAudioPlaying(true)}
                    preload="auto" // 预加载音频以减少延迟
                  />
                </div>
              </div>
            );
          }

          // SOS音频播放视图
          if (currentView === 'audio') {
            if (uploadedAudios.length === 0) {
              return (
                <div className="min-h-screen bg-gradient-to-br from-green-100 to-blue-100 p-4 flex items-center justify-center">
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-8 rounded-xl shadow-lg text-center max-w-md">
                    <Mic className="w-16 h-16 text-pink-500 mx-auto mb-4" />
                    <h2 className="text-xl font-bold mb-4">
                      {language === 'zh' ? '还没有音频文件' : 'No Audio Files'}
                    </h2>
                    <p className="text-gray-600 mb-6">
                      {language === 'zh' ? 
                        '请先上传一些音频文件来使用语音功能' : 
                        'Please upload some audio files to use voice feature'}
                    </p>
                    <button
                      onClick={() => setCurrentView('audios')}
                      className="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors"
                    >
                      {language === 'zh' ? '去上传文件' : 'Upload Files'}
                    </button>
                  </div>
                </div>
              );
            }

            const currentAudio = uploadedAudios[currentIndex] || uploadedAudios[0];
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-100 to-blue-100 p-4 flex items-center justify-center">
                <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-8 rounded-xl shadow-lg text-center max-w-md">
                  <Mic className="w-16 h-16 text-pink-500 mx-auto mb-4" />
                  <h2 className="text-xl font-bold mb-4">{currentAudio.fileName}</h2>
                  <p className="text-sm text-gray-500 mb-2">{currentAudio.fileSize}</p>
                  
                  {/* 显示当前播放进度 */}
                  <p className="text-sm text-blue-600 mb-4">
                    {language === 'zh' ? 
                      `播放进度: ${currentIndex + 1} / ${uploadedAudios.length}` : 
                      `Playing: ${currentIndex + 1} / ${uploadedAudios.length}`}
                  </p>
                  
                  {/* 显示播放状态 */}
                  {isAudioPlaying && (
                    <div className="mb-4 text-green-600">
                      <p className="text-sm">
                        {language === 'zh' ? '🎵 正在播放...' : '🎵 Playing...'}
                      </p>
                    </div>
                  )}
                  
                  <div className="flex justify-center space-x-4 mb-4">
                    {!isAudioPlaying && (
                      <button
                        onClick={() => {
                          if (audioRef.current && currentAudio.audioUrl) {
                            audioRef.current.src = currentAudio.audioUrl;
                            audioRef.current.play().then(() => {
                              setIsAudioPlaying(true);
                            });
                          }
                        }}
                        className="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors"
                      >
                        {language === 'zh' ? '播放' : 'Play'}
                      </button>
                    )}
                    {isAudioPlaying && (
                      <button
                        onClick={stopAudio}
                        className="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition-colors"
                      >
                        {language === 'zh' ? '停止' : 'Stop'}
                      </button>
                    )}
                    <button
                      onClick={() => {
                        // 确保停止音频并重置状态
                        if (audioRef.current) {
                          audioRef.current.pause();
                          audioRef.current.currentTime = 0;
                          setIsAudioPlaying(false);
                        }
                        setCurrentView('main');
                      }}
                      className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors"
                    >
                      {language === 'zh' ? '返回' : 'Back'}
                    </button>
                  </div>

                  {/* 手动切换按钮 */}
                  {uploadedAudios.length > 1 && (
                    <div className="flex justify-center space-x-2">
                      <button
                        onClick={() => {
                          const prevIndex = (currentIndex - 1 + uploadedAudios.length) % uploadedAudios.length;
                          setCurrentIndex(prevIndex);
                          const prevAudio = uploadedAudios[prevIndex];
                          if (prevAudio && audioRef.current) {
                            // 立即切换，无延迟
                            audioRef.current.src = prevAudio.audioUrl;
                            audioRef.current.play();
                          }
                        }}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        {language === 'zh' ? '← 上一首' : '← Previous'}
                      </button>
                      <button
                        onClick={() => {
                          // 立即播放下一首
                          playNextAudio();
                        }}
                        className="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        {language === 'zh' ? '下一首 →' : 'Next →'}
                      </button>
                    </div>
                  )}

                  <audio 
                    ref={audioRef} 
                    style={{ display: 'none' }} 
                    onEnded={playNextAudio} // 音频结束立即播放下一首
                    onPause={() => setIsAudioPlaying(false)}
                    onPlay={() => setIsAudioPlaying(true)}
                    preload="auto" // 预加载音频以减少延迟
                  />
                </div>
              </div>
            );
          }

          // 照片管理视图 - 增加上传功能
          if (currentView === 'photos') {
            return (
              <div className="min-h-screen bg-gray-50 p-4">
                <div className="max-w-md mx-auto">
                  <div className="flex items-center justify-between mb-6 pt-8">
                    <button
                      onClick={() => setCurrentView('main')}
                      className="text-blue-500 font-semibold"
                    >
                      {t.back}
                    </button>
                    <h2 className="text-xl font-bold">{t.safePhotos}</h2>
                    <div></div>
                  </div>

                  {/* 照片上传区域 */}
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-6 rounded-xl shadow-md mb-6">
                    <h3 className="font-semibold mb-4 text-center">
                      {language === 'zh' ? '上传安全照片' : 'Upload Safe Photos'}
                    </h3>
                    
                    {/* 温暖的使用说明 */}
                    <div className="bg-gradient-to-r from-pink-100 to-rose-100 border border-pink-200 p-4 rounded-lg mb-4">
                      <p className="text-sm text-gray-700 leading-relaxed text-center">
                        {language === 'zh' ? 
                          '📷 上传那些让你感到安全和快乐的照片 - 家人的笑容、朋友的陪伴、美丽的风景，或任何能带给你温暖回忆的瞬间。' : 
                          '📷 Upload photos that make you feel safe and happy - family smiles, friends\' company, beautiful scenery, or any moments that bring you warm memories.'}
                      </p>
                    </div>
                    
                    <p className="text-sm text-gray-600 mb-4 text-center">
                      {language === 'zh' ? 
                        '支持格式: JPG, PNG, GIF, WEBP, BMP' : 
                        'Supported: JPG, PNG, GIF, WEBP, BMP'}
                    </p>
                    
                    <div className="relative">
                      <input
                        type="file"
                        accept="image/*,.jpg,.jpeg,.png,.gif,.webp,.bmp"
                        multiple
                        onChange={(e) => {
                          const files = Array.from(e.target.files);
                          files.forEach((file, index) => {
                            const url = URL.createObjectURL(file);
                            const newPhoto = {
                              id: Date.now() + index,
                              fileName: file.name,
                              url: url,
                              fileSize: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                              description: { 
                                zh: file.name.replace(/\.[^/.]+$/, ""), 
                                en: file.name.replace(/\.[^/.]+$/, "") 
                              },
                              isDefault: false
                            };
                            setUploadedPhotos(prev => [...prev, newPhoto]);
                          });
                          e.target.value = '';
                        }}
                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        id="photoUpload"
                      />
                      <label 
                        htmlFor="photoUpload"
                        className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-pink-300 rounded-lg cursor-pointer hover:border-pink-500 hover:bg-pink-100 transition-all"
                      >
                        <Camera className="w-8 h-8 text-gray-400 mb-2" />
                        <p className="text-sm text-gray-600 text-center px-4">
                          {language === 'zh' ? 
                            '点击选择照片或拖拽到这里' : 
                            'Click to select photos or drag them here'}
                        </p>
                      </label>
                    </div>
                  </div>

                  {/* 照片网格显示 - 添加拖拽功能 */}
                  <h4 className="font-semibold text-gray-800 mb-4">
                    {language === 'zh' ? '所有照片 (拖拽重新排序)' : 'All Photos (Drag to Reorder)'}
                  </h4>
                  <div className="grid grid-cols-2 gap-4">
                    {allPhotos.map((photo, index) => (
                      <div 
                        key={photo.id} 
                        draggable
                        onDragStart={(e) => handleDragStart(e, index, 'photo')}
                        onDragOver={(e) => handleDragOver(e, index)}
                        onDragLeave={handleDragLeave}
                        onDrop={(e) => handleDrop(e, index, 'photo')}
                        onDragEnd={handleDragEnd}
                        className={`relative cursor-move transition-all duration-200 ${
                          draggedItem && draggedItem.index === index && draggedItem.type === 'photo' ? 'opacity-50 scale-95' : ''
                        } ${
                          dragOverIndex === index && draggedItem !== null && draggedItem.type === 'photo' && draggedItem.index !== index 
                            ? 'border-2 border-pink-400 border-dashed transform scale-105 rounded-lg' 
                            : ''
                        }`}
                      >
                        <img
                          src={photo.url}
                          alt={photo.description[language]}
                          className="w-full object-cover rounded-lg"
                          style={{
                            height: 'auto',
                            aspectRatio: '4/3',
                            maxHeight: '200px'
                          }}
                        />
                        <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-2 rounded-b-lg">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center flex-1 min-w-0">
                              <span className="bg-pink-500 text-white text-xs px-2 py-1 rounded-full mr-2 flex-shrink-0">
                                {index + 1}
                              </span>
                              <p className="text-xs truncate">{photo.description[language]}</p>
                            </div>
                            <div className="flex space-x-1 ml-2 flex-shrink-0">
                              {index > 0 && (
                                <button
                                  onClick={() => {
                                    const newPhotos = [...allPhotos];
                                    const temp = newPhotos[index];
                                    newPhotos[index] = newPhotos[index - 1];
                                    newPhotos[index - 1] = temp;
                                    // 更新用户照片状态
                                    const userPhotos = newPhotos.filter(p => !p.isDefault);
                                    setUploadedPhotos(userPhotos);
                                  }}
                                  className="bg-blue-500 text-white w-6 h-6 rounded text-xs hover:bg-blue-600 transition-colors flex items-center justify-center"
                                >
                                  ↑
                                </button>
                              )}
                              {index < allPhotos.length - 1 && (
                                <button
                                  onClick={() => {
                                    const newPhotos = [...allPhotos];
                                    const temp = newPhotos[index];
                                    newPhotos[index] = newPhotos[index + 1];
                                    newPhotos[index + 1] = temp;
                                    // 更新用户照片状态
                                    const userPhotos = newPhotos.filter(p => !p.isDefault);
                                    setUploadedPhotos(userPhotos);
                                  }}
                                  className="bg-blue-500 text-white w-6 h-6 rounded text-xs hover:bg-blue-600 transition-colors flex items-center justify-center"
                                >
                                  ↓
                                </button>
                              )}
                              <button
                                onClick={() => {
                                  if (photo.isDefault) {
                                    setDefaultPhotos(prev => prev.filter(p => p.id !== photo.id));
                                  } else {
                                    setUploadedPhotos(prev => prev.filter(p => p.id !== photo.id));
                                    URL.revokeObjectURL(photo.url);
                                  }
                                }}
                                className="bg-red-500 text-white w-6 h-6 rounded text-xs hover:bg-red-600 transition-colors flex items-center justify-center"
                              >
                                ×
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* 空状态 */}
                  {allPhotos.length === 0 && (
                    <div className="text-center text-gray-500 mt-8">
                      <Camera className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                      <p className="mb-2 font-medium">
                        {language === 'zh' ? '还没有任何照片' : 'No photos yet'}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          return null;
        };

        ReactDOM.render(React.createElement(EmotionalSupportApp), document.getElementById('root'));
    </script>
</body>
</html>