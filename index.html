<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æƒ…ç»ªæ”¯æŒåŠ©æ‰‹</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="ä¸€ä¸ªç»¼åˆæ€§çš„æƒ…ç»ªæ”¯æŒåº”ç”¨ï¼Œåœ¨å›°éš¾æ—¶åˆ»é€šè¿‡ç…§ç‰‡ã€éŸ³é¢‘å’Œæ­£é¢å›å¿†æä¾›å®‰æ…°">
    <meta name="keywords" content="æƒ…ç»ªæ”¯æŒ,å¿ƒç†å¥åº·,å†¥æƒ³,æ”¾æ¾,æƒ…ç»ªç®¡ç†,å¿ƒç†è¾…åŠ©">
    <meta name="author" content="Emotional Support Team">
    
    <!-- PWA Display -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EmotionalSupport">
    <meta name="application-name" content="EmotionalSupport">
    <meta name="msapplication-TileColor" content="#EC4899">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#EC4899">
    <meta name="msapplication-navbutton-color" content="#EC4899">
    <meta name="apple-mobile-web-app-status-bar-style" content="#EC4899">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicons and Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" href="/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="384x384" href="/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-192x192.png">
    
    <!-- Windows Tiles -->
    <meta name="msapplication-TileImage" content="/icon-144x144.png">
    <meta name="msapplication-square70x70logo" content="/icon-72x72.png">
    <meta name="msapplication-square150x150logo" content="/icon-152x152.png">
    <meta name="msapplication-wide310x150logo" content="/icon-384x384.png">
    <meta name="msapplication-square310x310logo" content="/icon-384x384.png">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="æƒ…ç»ªæ”¯æŒåŠ©æ‰‹ - Emotional Support Assistant">
    <meta property="og:description" content="åœ¨å›°éš¾æ—¶åˆ»æä¾›æƒ…ç»ªæ”¯æŒå’Œå®‰æ…°çš„åº”ç”¨">
    <meta property="og:image" content="/icon-512x512.png">
    <meta property="og:url" content="https://your-domain.netlify.app">
    <meta property="og:site_name" content="Emotional Support Assistant">
    <meta property="og:locale" content="zh_CN">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="æƒ…ç»ªæ”¯æŒåŠ©æ‰‹">
    <meta name="twitter:description" content="åœ¨å›°éš¾æ—¶åˆ»æä¾›æƒ…ç»ªæ”¯æŒå’Œå®‰æ…°çš„åº”ç”¨">
    <meta name="twitter:image" content="/icon-512x512.png">
    
    <!-- Preconnect to improve performance -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://images.unsplash.com">
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS for PWA -->
    <style>
        /* Prevent zoom on iOS */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Hide scrollbars in PWA mode */
        @media all and (display-mode: standalone) {
            body {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* Ensure full height on mobile */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #EC4899;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: #EC4899;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Install prompt styles */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #EC4899;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .install-prompt.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">æƒ…ç»ªæ”¯æŒåŠ©æ‰‹æ­£åœ¨å¯åŠ¨...</div>
    </div>
    
    <!-- Install Prompt -->
    <div id="install-prompt" class="install-prompt">
        <span>å®‰è£…åº”ç”¨åˆ°ä¸»å±å¹•ï¼Œéšæ—¶è·å¾—æ”¯æŒ ğŸ’</span>
        <button onclick="installApp()" style="margin-left: 10px; background: white; color: #EC4899; border: none; padding: 4px 12px; border-radius: 12px; font-weight: 600;">å®‰è£…</button>
        <button onclick="dismissInstall()" style="margin-left: 5px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 4px 8px; border-radius: 12px;">Ã—</button>
    </div>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // ç®€å•çš„SVGå›¾æ ‡ç»„ä»¶
        const Heart = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        );

        const Camera = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
        );

        const Mic = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
        );

        const MessageCircle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
        );

        const Globe = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </svg>
        );

        // æ–°å¢æ–‡æ¡£å›¾æ ‡
        const FileText = ({ className }) => (
          <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <line x1="10" y1="9" x2="8" y2="9"/>
          </svg>
        );

        const EmotionalSupportApp = () => {
          const [currentView, setCurrentView] = useState('main');
          const [sosMode, setSosMode] = useState('photo');
          const [mixedMode, setMixedMode] = useState('photo-audio');
          const [currentIndex, setCurrentIndex] = useState(0);
          const [language, setLanguage] = useState('zh');
          const [photoDuration, setPhotoDuration] = useState(12);
          const [uploadedAudios, setUploadedAudios] = useState([]);
          const [uploadedPhotos, setUploadedPhotos] = useState([]);
          const [defaultPhotos, setDefaultPhotos] = useState([
            { 
              id: 1, 
              url: 'https://images.unsplash.com/photo-1544027993-37dbfe43562a?w=800&h=600&fit=crop&q=80', 
              description: { zh: 'å’Œå¥½æœ‹å‹çš„åˆç…§', en: 'Photo with good friends' },
              isDefault: true
            },
            { 
              id: 2, 
              url: 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=800&h=600&fit=crop&q=80', 
              description: { zh: 'åˆä¸­æ—¶å…‰', en: 'Middle school days' },
              isDefault: true
            },
            { 
              id: 3, 
              url: 'https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=800&h=600&fit=crop&q=80', 
              description: { zh: 'æ¸©æš–çš„å›å¿†', en: 'Warm memories' },
              isDefault: true
            }
          ]);
          const [defaultMemories, setDefaultMemories] = useState([
            { 
              id: 1, 
              title: { zh: 'ç¬¬ä¸€æ¬¡è·å¥–', en: 'First Award' }, 
              content: { zh: 'è®°å¾—é‚£å¤©ä½ ç‰¹åˆ«å¼€å¿ƒï¼Œçœ¼ç›éƒ½åœ¨å‘å…‰', en: 'Remember how happy you were that day, your eyes were shining' },
              isDefault: true
            },
            { 
              id: 2, 
              title: { zh: 'å’Œæœ‹å‹çš„åˆé¤', en: 'Lunch with Friends' }, 
              content: { zh: 'é‚£æ¬¡èŠå¤©èŠåˆ°å¿˜è®°æ—¶é—´ï¼Œä½ ç¬‘å¾—ç‰¹åˆ«ç¿çƒ‚', en: 'That time you chatted until you forgot the time, you smiled so brightly' },
              isDefault: true
            },
            { 
              id: 3, 
              title: { zh: 'å…‹æœå›°éš¾', en: 'Overcoming Challenges' }, 
              content: { zh: 'ä½ æ›¾ç»è§‰å¾—ä¸å¯èƒ½çš„äº‹æƒ…ï¼Œæœ€åéƒ½åšåˆ°äº†', en: 'Things you once thought impossible, you eventually accomplished them all' },
              isDefault: true
            }
          ]);
          const [notepadContent, setNotepadContent] = useState('');
          const [isAudioPlaying, setIsAudioPlaying] = useState(false);
          const [draggedItem, setDraggedItem] = useState(null);
          const [dragOverIndex, setDragOverIndex] = useState(null);
          const intervalRef = useRef(null);
          const audioRef = useRef(null);

          // PWAåˆå§‹åŒ–
          useEffect(() => {
            // å¤„ç†URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('sos') === 'true') {
              handleSOS();
            } else if (urlParams.get('view')) {
              setCurrentView(urlParams.get('view'));
            }

            // éšè—åŠ è½½å±å¹•
            setTimeout(() => {
              const loadingScreen = document.getElementById('loading-screen');
              if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                  loadingScreen.style.display = 'none';
                }, 500);
              }
            }, 1500);

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå®‰è£…æç¤º
            setTimeout(() => {
              if (window.deferredPrompt) {
                showInstallPrompt();
              }
            }, 3000);
          }, []);

          // å¤šè¯­è¨€æ–‡æœ¬
          const texts = {
            zh: {
              title: 'æƒ…ç»ªæ”¯æŒåŠ©æ‰‹',
              subtitle: 'ä½ ä¸æ˜¯ä¸€ä¸ªäººï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé™ªä¼´ä½ ',
              sosButton: 'ğŸ†˜ ç´§æ€¥å®‰æŠš',
              photoMode: 'ğŸ“¸ å®‰å…¨ç…§ç‰‡',
              audioMode: 'ğŸµ æ¸©æš–å£°éŸ³',
              messageMode: 'ğŸ’­ æ­£é¢è®°å¿†',
              mixedMode: 'ğŸ”„ æ··åˆæ¨¡å¼',
              photoAudioMode: 'ğŸ“¸ğŸµ ç…§ç‰‡+éŸ³ä¹',
              memoryAudioMode: 'ğŸ’­ğŸµ æ–‡å­—+éŸ³ä¹',
              safePhotos: 'å®‰å…¨ç…§ç‰‡',
              supportSounds: 'æ”¯æŒå£°éŸ³',
              positiveMemories: 'æ­£é¢è®°å¿†',
              photosCount: 'å¼ ç…§ç‰‡',
              audiosCount: 'æ®µå½•éŸ³',
              memoriesCount: 'ä¸ªå›å¿†',
              stop: 'åœæ­¢',
              back: 'â† è¿”å›',
              yourMemories: 'ä½ çš„ç¾å¥½å›å¿†',
              returnHome: 'è¿”å›ä¸»é¡µ',
              photoDuration: 'ç…§ç‰‡åœç•™æ—¶é—´',
              seconds: 'ç§’',
              minute: 'åˆ†é’Ÿ',
              minutes: 'åˆ†é’Ÿ',
              permanent: 'æ°¸ä¹…',
              photoSettings: 'ç…§ç‰‡è®¾ç½®',
              replay: 'é‡æ’­',
              pause: 'æš‚åœ',
              resume: 'ç»§ç»­'
            },
            en: {
              title: 'Emotional Support Assistant',
              subtitle: 'You are not alone, we are here with you',
              sosButton: 'ğŸ†˜ Emergency Comfort',
              photoMode: 'ğŸ“¸ Safe Photos',
              audioMode: 'ğŸµ Warm Sounds',
              messageMode: 'ğŸ’­ Positive Memories',
              mixedMode: 'ğŸ”„ Mixed Mode',
              photoAudioMode: 'ğŸ“¸ğŸµ Photo+Music',
              memoryAudioMode: 'ğŸ’­ğŸµ Text+Music',
              safePhotos: 'Safe Photos',
              supportSounds: 'Support Sounds',
              positiveMemories: 'Positive Memories',
              photosCount: 'photos',
              audiosCount: 'audios',
              memoriesCount: 'memories',
              stop: 'Stop',
              back: 'â† Back',
              yourMemories: 'Your Beautiful Memories',
              returnHome: 'Return Home',
              photoDuration: 'Photo Duration',
              seconds: 'seconds',
              minute: 'minute',
              minutes: 'minutes',
              permanent: 'Permanent',
              photoSettings: 'Photo Settings',
              replay: 'Replay',
              pause: 'Pause',
              resume: 'Resume'
            }
          };

          const t = texts[language];

          // åˆå¹¶é»˜è®¤ç…§ç‰‡å’Œç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡
          const allPhotos = [...defaultPhotos, ...uploadedPhotos];

          // åˆå¹¶é»˜è®¤å›å¿†å’ŒNotepadå†…å®¹
          const allMemories = notepadContent.trim() ? 
            [...defaultMemories, {
              id: 'notepad',
              title: { zh: 'æˆ‘çš„å¿ƒçµç¬”è®°', en: 'My Heart Notes' },
              content: { zh: notepadContent, en: notepadContent },
              isNotepad: true
            }] : defaultMemories;

          // æ‹–æ‹½æ’åºåŠŸèƒ½
          const handleDragStart = (e, index, type) => {
            setDraggedItem({ index, type });
            e.dataTransfer.effectAllowed = 'move';
          };

          const handleDragOver = (e, index) => {
            e.preventDefault();
            setDragOverIndex(index);
          };

          const handleDragLeave = () => {
            setDragOverIndex(null);
          };

          const handleDrop = (e, dropIndex, type) => {
            e.preventDefault();
            if (draggedItem !== null && draggedItem.index !== dropIndex && draggedItem.type === type) {
              if (type === 'audio') {
                const newAudios = [...uploadedAudios];
                const draggedAudio = newAudios[draggedItem.index];
                newAudios.splice(draggedItem.index, 1);
                newAudios.splice(dropIndex, 0, draggedAudio);
                setUploadedAudios(newAudios);
              } else if (type === 'photo') {
                const newPhotos = [...allPhotos];
                const draggedPhoto = newPhotos[draggedItem.index];
                newPhotos.splice(draggedItem.index, 1);
                newPhotos.splice(dropIndex, 0, draggedPhoto);
                const defaultPhotos = newPhotos.filter(p => p.isDefault);
                const userPhotos = newPhotos.filter(p => !p.isDefault);
                setUploadedPhotos(userPhotos);
              }
            }
            setDraggedItem(null);
            setDragOverIndex(null);
          };

          const handleDragEnd = () => {
            setDraggedItem(null);
            setDragOverIndex(null);
          };

          // éŸ³é¢‘æ’­æ”¾æ§åˆ¶å‡½æ•°
          const playAudio = (audioUrl) => {
            if (audioRef.current) {
              audioRef.current.src = audioUrl;
              audioRef.current.play().then(() => {
                setIsAudioPlaying(true);
              }).catch(err => {
                alert(language === 'zh' ? 'æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ ¼å¼' : 'Playback failed, check audio format');
              });
            }
          };

          const pauseAudio = () => {
            if (audioRef.current) {
              audioRef.current.pause();
              setIsAudioPlaying(false);
            }
          };

          const resumeAudio = () => {
            if (audioRef.current) {
              audioRef.current.play().then(() => {
                setIsAudioPlaying(true);
              });
            }
          };

          const stopAudio = () => {
            if (audioRef.current) {
              audioRef.current.pause();
              audioRef.current.currentTime = 0;
              setIsAudioPlaying(false);
            }
          };

          // SOSæŒ‰é’®åŠŸèƒ½
          const handleSOS = () => {
            setCurrentIndex(0);
            
            if (sosMode === 'photo') {
              startPhotoSlideshow();
            } else if (sosMode === 'audio') {
              if (uploadedAudios.length > 0) {
                setCurrentView('audio');
                setTimeout(() => {
                  const firstAudio = uploadedAudios[0];
                  if (firstAudio && audioRef.current) {
                    audioRef.current.src = firstAudio.audioUrl;
                    audioRef.current.play().then(() => {
                      setIsAudioPlaying(true);
                    }).catch(err => {
                      console.log('åˆå§‹æ’­æ”¾å¤±è´¥ï¼Œé‡è¯•:', err);
                      setTimeout(() => {
                        audioRef.current.play();
                      }, 50);
                    });
                  }
                }, 50);
              } else {
                setCurrentView('audio');
              }
            } else if (sosMode === 'message') {
              if (allMemories.length > 0) {
                setCurrentView('memories-slideshow');
              } else {
                setCurrentView('memories');
              }
            } else if (sosMode === 'mixed') {
              if (mixedMode === 'photo-audio') {
                if (allPhotos.length > 0 && uploadedAudios.length > 0) {
                  setCurrentView('mixed-photo-audio');
                  if (photoDuration > 0) {
                    intervalRef.current = setInterval(() => {
                      setCurrentIndex(prev => (prev + 1) % allPhotos.length);
                    }, photoDuration * 1000);
                  }
                  setTimeout(() => {
                    const firstAudio = uploadedAudios[0];
                    if (firstAudio && audioRef.current) {
                      audioRef.current.src = firstAudio.audioUrl;
                      audioRef.current.play().then(() => {
                        setIsAudioPlaying(true);
                      }).catch(err => {
                        console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œé‡è¯•:', err);
                        setTimeout(() => {
                          audioRef.current.play();
                        }, 50);
                      });
                    }
                  }, 50);
                } else {
                  alert(language === 'zh' ? 'éœ€è¦åŒæ—¶æœ‰ç…§ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶æ‰èƒ½ä½¿ç”¨æ­¤æ¨¡å¼' : 'Need both photos and audio files to use this mode');
                }
              } else if (mixedMode === 'memory-audio') {
                if (allMemories.length > 0 && uploadedAudios.length > 0) {
                  setCurrentView('mixed-memory-audio');
                  setTimeout(() => {
                    const firstAudio = uploadedAudios[0];
                    if (firstAudio && audioRef.current) {
                      audioRef.current.src = firstAudio.audioUrl;
                      audioRef.current.play().then(() => {
                        setIsAudioPlaying(true);
                      }).catch(err => {
                        console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œé‡è¯•:', err);
                        setTimeout(() => {
                          audioRef.current.play();
                        }, 50);
                      });
                    }
                  }, 50);
                } else {
                  alert(language === 'zh' ? 'éœ€è¦åŒæ—¶æœ‰å›å¿†å’ŒéŸ³é¢‘æ–‡ä»¶æ‰èƒ½ä½¿ç”¨æ­¤æ¨¡å¼' : 'Need both memories and audio files to use this mode');
                }
              }
            }
          };

          // æ’­æ”¾ä¸‹ä¸€é¦–éŸ³é¢‘
          const playNextAudio = () => {
            if (uploadedAudios.length > 1) {
              const nextIndex = (currentIndex + 1) % uploadedAudios.length;
              setCurrentIndex(nextIndex);
              const nextAudio = uploadedAudios[nextIndex];
              if (nextAudio && audioRef.current) {
                audioRef.current.src = nextAudio.audioUrl;
                audioRef.current.play().catch(err => {
                  console.log('æ’­æ”¾å¤±è´¥ï¼Œå°è¯•é‡æ–°æ’­æ”¾:', err);
                  setTimeout(() => {
                    audioRef.current.play();
                  }, 50);
                });
              }
            } else if (uploadedAudios.length === 1) {
              if (audioRef.current) {
                audioRef.current.currentTime = 0;
                audioRef.current.play();
              }
            }
          };

          const startPhotoSlideshow = () => {
            setCurrentView('slideshow');
            if (photoDuration > 0) {
              intervalRef.current = setInterval(() => {
                setCurrentIndex(prev => (prev + 1) % allPhotos.length);
              }, photoDuration * 1000);
            }
          };

          const stopSOS = () => {
            if (intervalRef.current) {
              clearInterval(intervalRef.current);
            }
            if (audioRef.current) {
              audioRef.current.pause();
              audioRef.current.currentTime = 0;
              setIsAudioPlaying(false);
            }
            setCurrentView('main');
          };

          // ä¸»ç•Œé¢
          if (currentView === 'main') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                <div className="max-w-md mx-auto">
                  {/* è¯­è¨€åˆ‡æ¢æŒ‰é’® */}
                  <div className="flex justify-end pt-4 mb-4">
                    <button
                      onClick={() => setLanguage(language === 'zh' ? 'en' : 'zh')}
                      className="flex items-center space-x-2 bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 px-3 py-2 rounded-lg shadow-sm hover:from-pink-100 hover:to-rose-100"
                    >
                      <Globe className="w-4 h-4 text-gray-600" />
                      <span className="text-sm text-gray-600">
                        {language === 'zh' ? 'EN' : 'ä¸­æ–‡'}
                      </span>
                    </button>
                  </div>

                  {/* æ ‡é¢˜ */}
                  <div className="text-center mb-8">
                    <Heart className="w-12 h-12 text-pink-500 mx-auto mb-2" />
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">{t.title}</h1>
                    <p className="text-gray-600">{t.subtitle}</p>
                  </div>

                  {/* SOS æŒ‰é’® */}
                  <div className="mb-8">
                    <button
                      onClick={handleSOS}
                      className="w-full bg-red-500 hover:bg-red-600 text-white text-xl font-bold py-6 px-8 rounded-full shadow-lg transform transition-all duration-200 hover:scale-105 active:scale-95"
                    >
                      {t.sosButton}
                    </button>
                    
                    {/* SOS æ¨¡å¼é€‰æ‹© */}
                    <div className="mt-4 grid grid-cols-2 gap-2">
                      <button
                        onClick={() => setSosMode('photo')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'photo' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.photoMode}
                      </button>
                      <button
                        onClick={() => setSosMode('audio')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'audio' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.audioMode}
                      </button>
                      <button
                        onClick={() => setSosMode('message')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'message' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.messageMode}
                      </button>
                      <button
                        onClick={() => setSosMode('mixed')}
                        className={`py-2 px-4 rounded-lg text-sm transition-colors ${sosMode === 'mixed' ? 'bg-blue-500 text-white' : 'bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 text-gray-700'}`}
                      >
                        {t.mixedMode}
                      </button>
                    </div>

                    {/* æ··åˆæ¨¡å¼çš„å­é€‰é¡¹ */}
                    {sosMode === 'mixed' && (
                      <div className="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg">
                        <p className="text-sm text-gray-700 mb-3 text-center font-medium">
                          {language === 'zh' ? 'é€‰æ‹©æ··åˆæ¨¡å¼ç±»å‹:' : 'Choose Mixed Mode Type:'}
                        </p>
                        <div className="grid grid-cols-1 gap-2">
                          <button
                            onClick={() => setMixedMode('photo-audio')}
                            className={`py-3 px-4 rounded-lg text-sm transition-colors ${mixedMode === 'photo-audio' ? 'bg-purple-500 text-white' : 'bg-white border border-purple-200 text-gray-700 hover:bg-purple-50'}`}
                          >
                            {t.photoAudioMode}
                            <p className="text-xs mt-1 opacity-80">
                              {language === 'zh' ? 'åŒæ—¶æ’­æ”¾ç…§ç‰‡å¹»ç¯ç‰‡å’ŒèƒŒæ™¯éŸ³ä¹' : 'Play photo slideshow with background music'}
                            </p>
                          </button>
                          <button
                            onClick={() => setMixedMode('memory-audio')}
                            className={`py-3 px-4 rounded-lg text-sm transition-colors ${mixedMode === 'memory-audio' ? 'bg-purple-500 text-white' : 'bg-white border border-purple-200 text-gray-700 hover:bg-purple-50'}`}
                          >
                            {t.memoryAudioMode}
                            <p className="text-xs mt-1 opacity-80">
                              {language === 'zh' ? 'æ˜¾ç¤ºæ–‡å­—å›å¿†å¹¶æ’­æ”¾èƒŒæ™¯éŸ³ä¹' : 'Show text memories with background music'}
                            </p>
                          </button>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* è®¾ç½®åŒºåŸŸ */}
                  <div className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md mb-6">
                    <h3 className="font-semibold text-gray-800 mb-4 text-center">{t.photoSettings}</h3>
                    
                    <div>
                      <p className="text-sm text-gray-600 mb-2">{t.photoDuration}:</p>
                      <div className="grid grid-cols-3 gap-2">
                        {[
                          { value: 10, label: `10 ${t.seconds}` },
                          { value: 20, label: `20 ${t.seconds}` },
                          { value: 60, label: `1 ${t.minute}` },
                          { value: 300, label: `5 ${t.minutes}` },
                          { value: 1800, label: `30 ${t.minutes}` },
                          { value: 0, label: t.permanent }
                        ].map(option => (
                          <button
                            key={option.value}
                            onClick={() => setPhotoDuration(option.value)}
                            className={`py-2 px-2 rounded-lg text-xs transition-colors ${
                              photoDuration === option.value 
                                ? 'bg-blue-500 text-white' 
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                          >
                            {option.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* åŠŸèƒ½å¡ç‰‡ */}
                  <div className="grid grid-cols-1 gap-4">
                    <div 
                      onClick={() => setCurrentView('photos')}
                      className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:from-pink-100 hover:to-rose-100 transition-all"
                    >
                      <div className="flex items-center">
                        <Camera className="w-8 h-8 text-pink-500 mr-3" />
                        <div>
                          <h3 className="font-semibold text-gray-800">{t.safePhotos}</h3>
                          <p className="text-sm text-gray-600">{allPhotos.length} {t.photosCount}</p>
                        </div>
                      </div>
                    </div>

                    <div 
                      onClick={() => setCurrentView('audios')}
                      className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:from-pink-100 hover:to-rose-100 transition-all"
                    >
                      <div className="flex items-center">
                        <Mic className="w-8 h-8 text-pink-500 mr-3" />
                        <div>
                          <h3 className="font-semibold text-gray-800">{t.supportSounds}</h3>
                          <p className="text-sm text-gray-600">{uploadedAudios.length} {t.audiosCount}</p>
                        </div>
                      </div>
                    </div>

                    <div 
                      onClick={() => setCurrentView('memories')}
                      className="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-100 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:from-pink-100 hover:to-rose-100 transition-all"
                    >
                      <div className="flex items-center">
                        <MessageCircle className="w-8 h-8 text-pink-500 mr-3" />
                        <div>
                          <h3 className="font-semibold text-gray-800">{t.positiveMemories}</h3>
                          <p className="text-sm text-gray-600">{allMemories.length} {t.memoriesCount}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // ç…§ç‰‡å¹»ç¯ç‰‡è§†å›¾
          if (currentView === 'slideshow') {
            return (
              <div className="min-h-screen bg-black relative flex items-center justify-center">
                <img
                  src={allPhotos[currentIndex]?.url}
                  alt={allPhotos[currentIndex]?.description[language]}
                  className="max-w-full max-h-full object-contain"
                  style={{
                    maxWidth: '90%',
                    maxHeight: '80%',
                    borderRadius: '12px',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.5)'
                  }}
                />
                <div className="absolute bottom-20 left-0 right-0 text-center">
                  <div className="bg-black bg-opacity-70 mx-4 p-4 rounded-lg">
                    <p className="text-white text-xl mb-4">{allPhotos[currentIndex]?.description[language]}</p>
                    <button
                      onClick={stopSOS}
                      className="bg-white text-black px-6 py-3 rounded-full font-semibold hover:bg-gray-100 transition-colors"
                    >
                      {t.stop}
                    </button>
                  </div>
                </div>
                
                <div className="absolute top-4 right-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg">
                  {currentIndex + 1} / {allPhotos.length}
                </div>

                <div className="absolute top-4 left-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg text-sm">
                  {photoDuration === 0 && t.permanent}
                  {photoDuration === 10 && `10 ${t.seconds}`}
                  {photoDuration === 20 && `20 ${t.seconds}`}
                  {photoDuration === 60 && `1 ${t.minute}`}
                  {photoDuration === 300 && `5 ${t.minutes}`}
                  {photoDuration === 1800 && `30 ${t.minutes}`}
                </div>
                
                <button
                  onClick={() => setCurrentIndex((prev) => (prev - 1 + allPhotos.length) % allPhotos.length)}
                  className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all"
                >
                  â†
                </button>
                <button
                  onClick={() => setCurrentIndex((prev) => (prev + 1) % allPhotos.length)}
                  className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all"
                >
                  â†’
                </button>
              </div>
            );
          }

          // å…¶ä»–è§†å›¾ä»£ç ç»§ç»­...
          // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¾ç¤ºä¸»è¦çš„è§†å›¾ï¼Œå…¶ä»–è§†å›¾ä¿æŒåŸæœ‰é€»è¾‘

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4 flex items-center justify-center">
              <div className="text-center">
                <h2 className="text-xl font-bold mb-4">åŠŸèƒ½å¼€å‘ä¸­...</h2>
                <button
                  onClick={() => setCurrentView('main')}
                  className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors"
                >
                  {t.back}
                </button>
              </div>
            </div>
          );
        };

        ReactDOM.render(React.createElement(EmotionalSupportApp), document.getElementById('root'));
    </script>

    <!-- PWA Installation Script -->
    <script>
        let deferredPrompt;
        let installPromptShown = false;

        // Check if app is already installed
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // Show install prompt
        function showInstallPrompt() {
            if (!installPromptShown && !isAppInstalled() && deferredPrompt) {
                const prompt = document.getElementById('install-prompt');
                if (prompt) {
                    prompt.classList.add('show');
                    installPromptShown = true;
                }
            }
        }

        // Install app function
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                dismissInstall();
            }
        }

        // Dismiss install prompt
        function dismissInstall() {
            const prompt = document.getElementById('install-prompt');
            if (prompt) {
                prompt.classList.remove('show');
            }
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('Install prompt captured');
        });

        // Listen for app installed event
        window.addEventListener('appinstalled', (evt) => {
            console.log('App was installed');
            dismissInstall();
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    
                    console.log('ServiceWorker registration successful:', registration.scope);
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                if (confirm('æ–°ç‰ˆæœ¬å·²å°±ç»ªï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('ServiceWorker registration failed:', error);
                }
            });
        }

        // Handle share target
        if ('serviceWorker' in navigator && 'share_target' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SHARED_FILES') {
                    console.log('Received shared files:', event.data.files);
                }
            });
        }

        // Prevent zoom on double tap (iOS)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('App became visible');
            }
        });

        // Handle network status
        window.addEventListener('online', () => {
            console.log('App is online');
        });

        window.addEventListener('offline', () => {
            console.log('App is offline');
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
            }
        });

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });
    </script>
</body>
</html>
